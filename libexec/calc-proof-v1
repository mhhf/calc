#!/usr/bin/env node
/**
 * @deprecated Use calc-proof-v2 instead for the new v2 prover (5-8x faster)
 *   calc proof-v2 "P, P -o Q |- Q"
 */

const calc = require('../ll.json');
const Calc = require("../lib/calc.js");
const Sequent = require("../lib/sequent.js");
const PT = require("../lib/pt.js");
const Proofstate = require("../lib/proofstate.js");
const Ruleset = require("../lib/ruleset.js");
const clc = require('cli-color');
const { profiler } = require("../lib/profiler.js");

// Initialize calculus
Calc.init(calc);
const {rules, bwd, getRule} = Ruleset.init();

const calcParser = require("../lib/parser.js");
const Parser = calcParser();
const parser = Parser.parser;

let args = process.argv.slice(2);

// Parse flags
let showProfile = args.includes('--profile');
args = args.filter(a => a !== '--profile');

// Examples (using -- for "any term", * for tensor, & for with, -o for lolli)
// let formulaStr = "-- : P, -- : P -o Q |- -- : Q";  // modus ponens
// let formulaStr = "-- : P * Q |- -- : P * Q";       // identity for tensor
let formulaStr = "-- : P -o (R & Q) |- -- : (P -o Q) & (P -o R)";  // distribution
const formula = args && args[0] || formulaStr;

// Enable profiling if requested
if (showProfile) {
  profiler.enable();
}

let node = parser.parse(formula)
let seq = Sequent.fromTree(node);

let pt = new PT({
  conclusion: seq
})

let atoms = Sequent.getAtoms(seq, {rules: Calc.db.rules});

let result = Proofstate.auto(pt, {
  positive: atoms,
  negative: [],
  debug: false,
  mode: 'proof',  // Enable forward chaining for identity proofs
  rules,
  bwd,
  getRule,
  calc
});

if(result && result.success) {
  console.log(`${clc.green("✔")} found proof for: ${seq}\n\n${pt.toString({})}`);
} else {
  console.log(`${clc.red("✗")} can't prove ${seq}`);
  console.log(`${pt}`);
}

// Show profiling results if enabled
if (showProfile) {
  console.log("\n" + profiler.report());
}
